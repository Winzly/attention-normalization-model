#Importing packages
import numpy as np
import matplotlib.pyplot as plt
from scipy.ndimage import gaussian_filter


def gaussian2d(x, theta, mu_x, mu_theta, sigma_x, sigma_theta):
    X, T = np.meshgrid(x, theta, indexing='ij')
    return np.exp(-0.5 * (((X - mu_x) / sigma_x) ** 2 + ((T - mu_theta) / sigma_theta) ** 2))

def normalization_model_2d(
    x, theta,
    stim_center_x, stim_width_x, stim_center_theta, stim_width_theta,
    attn_center_x, attn_width_x, attn_center_theta, attn_width_theta,
    suppression_width_x, suppression_width_theta,
    contrast=1.0,
    sigma=1.0,
):
    # Stimulus field: spatial x orientation Gaussian
    S = contrast * gaussian2d(x, theta, stim_center_x, stim_center_theta, stim_width_x, stim_width_theta)
    # Attention field (shape and spread over neuron prefs)
    A = gaussian2d(x, theta, attn_center_x, attn_center_theta, attn_width_x, attn_width_theta)
    # Excitation: attention * stimulus, for every neuron (x, theta)
    E = A * S
    # Suppressive drive: local normalization across x and orientation
    I = gaussian_filter(E, [suppression_width_x, suppression_width_theta])
    # Normalized response for each neuron
    R = E / (sigma + I)

    # Plot as heatmaps
    plt.figure(figsize=(15, 4))
    imargs = dict(origin='lower', aspect='auto',
                  extent=[x[0], x[-1], theta[0], theta[-1]])
    plt.subplot(1, 3, 1)
    plt.imshow(S.T, **imargs)
    plt.title('Stimulus S(x,θ)')
    plt.xlabel('Position x')
    plt.ylabel('Orientation θ')
    plt.colorbar()

    plt.subplot(1, 3, 2)
    plt.imshow(A.T, **imargs)
    plt.title('Attention A(x,θ)')
    plt.xlabel('Position x')
    plt.ylabel('Orientation θ')
    plt.colorbar()

    plt.subplot(1, 3, 3)
    plt.imshow(R.T, **imargs)
    plt.title('Normalized Response R(x,θ)')
    plt.xlabel('Position x')
    plt.ylabel('Orientation θ')
    plt.colorbar()

    plt.tight_layout()
    plt.show()
    return R

# Example usage:
x = np.linspace(-50, 50, 101)
theta = np.linspace(-90, 90, 91)

resp = normalization_model_2d(
    x, theta,
    stim_center_x=0, stim_width_x=15,
    stim_center_theta=0, stim_width_theta=25,
    attn_center_x=15, attn_width_x=20,      # Try varying attention!
    attn_center_theta=30, attn_width_theta=35,
    suppression_width_x=12, suppression_width_theta=18,   # Suppression field size
    contrast=0.5,
    sigma=1.0,
)
